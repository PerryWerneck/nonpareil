Nonpareil - a calculator microassembler and simulator
Copyright 1995, 2003, 2004, 2005 Eric L. Smith <eric@brouhaha.com>
$Id$

-----------------------------------------------------------------------------

News:

Release 0.63 of Nonpareil is an interim development release.

In this release, the following calculators are simulated:
	HP-35, HP-45, HP-55, HP-80
	HP-21, HP-25
	HP-31E, HP-33C, HP-34C, HP-37E, HP-38E, HP-38C
	HP-41CV
	HP-11C, HP-15C, HP-16C

The menu commands other than "Quit" and "About" are not implemented.

There are a few known bugs in the simulations:

* The HP-55 simulation does not correctly support user registers
  .0 through .9.

-----------------------------------------------------------------------------

Background:

Nonpareil is a microcode-level simulator for electronic calculators.
Currently it is able to simulate some of the HP Classic and Woodstock
series calculators.

The HP-35, the first of HP's classic series of handheld calculators,
was introduced in 1972 and described as the "Electronic Slide Rule".
The HP-35 was a non-programmable scientific, and was followed by the
HP-45 improved scientific calculator, the HP-65 scientific
programmable with card reader, the HP-55 scientific programmable with
stopwatch, and the HP-70 and HP-80 business calculators.  All of these
calculators used essentially the same processor, which was also used
in the HP 3380 Integrator, the HP 5830 and HP 5840 Gas Chromatographs,
and the HP 1722 Oscilliscope.

In the HP Classic series processor, unlike modern microprocessors,
various instructions were interpreted by various chips.  The core
processor consists of the C&T (control and timing), A&R (arithmetic
and registers) and the ROM or QUAD ROM chips.  Additions chips may be
present for data storage or program storage.  Since different
calculator models have different combinations of these chips, some
instructions are not available on all models.  For instance, the
"delayed select" instructions are probably not implemented in the
HP-35 and HP-80 which use single ROMs, and the "search for label"
instruction is only available in the HP-65.

The design of the processor and the instruction set are described in
detail in United States patents 3,863,060 and 4,001,569.

I've typed in the source code from the '569, '379, and '060 patents
which cover the HP-45, HP-55, and HP-80 respectively.  The listings in
the patents were poorly reproduced.  Peter Monta found and corrected
several errors.  The code in the patents might not be identical to
that in production units; I plan to eventually dump the ROMs from
actual calculators.

Peter Monta also *optically* dumped the contents of the HP-35 ROMs,
and disassembled the resulting code.  I've cleaned it up a bit and
added labels using the HP-45 source code as a guide.
        http://www.pmonta.com/calculators/hp-35/

In 1975 HP introduced their second generation handheld calculators,
known internally as the Woodstock series.  These use an improved
processor architecture described in the article "Inside the New Pocket
Calculators" in the November 1975 issue of Hewlett-Packard Journal.
An online copy of this article is available from the Museum of HP
Calculators:
        http://www.hpmuseum.org/journals/woodb.htm

In 1978, HP introduced their third generation handheld calculators,
known internally as the Spice series.  These use essentially the same
processor architecture as the Woodstock series, with the addition of
an instruction to checksum a 1K region of ROM, used as part of a
self-test feature.

In 1979, HP introduced their first expandable scientific handheld
calculator, the HP-41C (Coconut).  It was the first calculator to use
the Nut processor architecture, which was also used in the Voyager series
(HP-11C, HP-12C, etc.) introduced in 1981.

-----------------------------------------------------------------------------

Nonpareil simulator:

Nonpareil is a microcode-level simulator for the hardware of the HP
Classic and Woodstock series of calculators.  It should be capable of
simulating the following calculators:

  Classic series:    HP-35, HP-45, HP-55, HP-70, HP-80
  Woodstock series:  HP-21, HP-22, HP-25, HP-25C, HP-27, HP-29C
  Spice series:      HP-31E, HP-32E, HP-33E, HP-33C, HP-37E, HP-38E, HP-38C
  Coconut:           HP-41C, HP-41CV
  Voyager:           HP-10C, HP-11C, HP-12C, HP-15C, HP-16C

Nonpareil uses the Gtk+ 2.2 toolkit and Glib 2.2.

Nonpareil uses a single command line argument to specify the KML file.
If no argument is found, nonpareil will try to find a file using the
concatentation of the name under which it was invoked and ".kml".
This allows you to (for instance) link nonpareil to "hp45" and have it
automatically try to use "hp45.kml".

Nonpareil attempts to run the simulation at the same nominal rate of
microinstruction execution as a real calculator, e.g., 3500
microinstructions per second for an HP-55.  The HP-55 used a crystal
oscillator, but most other models used an LC oscillator which was not
very accurate.  On a computer that is heavily loaded, the
microinstruction rate will be reduced, so the HP-55 timer mode (and the
undocumented HP-45 timer mode) will run slow.  Don't blame me if you try
to use it and burn your eggs.

If you want to use the undocumented timer mode of the HP-45, there are
comments in hp45.kml explaining the change necessary to that file.  On
a real HP-45 this feature was accessed by pressing RCL then the "right
half of the ENTER key".  The ENTER key actually covered two switches,
but the key was shaped so that it only pressed the left switch, and
the ROM was written so the right switch would provide the ENTER
function as well as allowing use of the timer mode.  It was possible
to either put a shim on the key, or to create a a phantom keystroke by
simultaneously pressing CHS, 7, and 8.  Nonpareil doesn't support multiple
key presses at all, so the KML change makes the simulator's ENTER
button produce the keycode for the right switch.

-----------------------------------------------------------------------------

Uasm microassembler:

Uasm requires a command line argument to specify the source code file
name, and optional arguments to specify object and listing file names.

The object file format is one word per line with the five digit octal
address, a colon and the instruction word in hexadecimal.

I personally prefer my assembly source code to be in all lower case,
so it doesn't look like it is shouting at me.  All the source code I
have typed in from patents is in lower case, but uasm is case
insensitive so if you prefer emphatic source code be my guest.

Uasm considers the keywords which are used to form instructions to be
reserved words, so they can't be used as labels.  HP's assembler was
more flexible in this regard; I had to change the label "go" in the
HP-55 source code to "go_".

Uasm does a better job of displaying the branch target addresses than
the HP assembler did.  It will actually show the correct target
address based on the delayed select instructions, unless the delay
instruction is in the last word of a page.  Uasm has a ".rom"
directive which can be used to provide the rom number.  This is
roughly equivalent to the origin directive in a typical assembler,
except that uasm always start assembling code at location 0 of the
selected ROM.

Because HP assembled each ROM separately, they were able to use the
same symbols in multiple ROMs.  uasm therefore has a separate name
space and keeps a separate symbol table for each ROM.

Uasm has a .symtab directive which causes the symbol table to be
printed to the listing file.  If the source file contains multiple
ROMs, each ROM should have its own .symtab directive.

The file "hp55.asm" when assembled with uasm will produce one warning,
which will be printed to standard out twice (once during each pass).
This warning can be ignored as it is the result of uasm being pickier
than the HP assembler about forms of the "go to" instruction.

-----------------------------------------------------------------------------

Installation:

The file INSTALLATION provides instructions for configuring, building,
and installing Nonpareil.

-----------------------------------------------------------------------------

Credits:

Nonpareil was originally written by Eric Smith.  Any bugs in it are
my fault.

Peter Monta provided the HP-35 code.  He also found and corrected
typographical errors in my entry of the HP-45 and HP-55 source code.

Steven Ellis and Steven Knight helped with the SConstruct and SConscript
files, which are used to build the Nonpareil using SCons rather than make.

The HP-41C image (hp41cv.png) is a stylized illustration rendered by
my older NSIM simulator with improvements by Maciej Bartosiak and
Thomas Olesen.

Thomas Olesen improved the HP-41CV KML file for a more realistic display
"font" and alpha keyboard mapping.

Images of the HP-21, HP-25, HP-32E, HP-33C, HP-34C, HP-35, HP-37E, HP-38C,
HP-45, HP-55, and HP-80 are copyrighted by David G. Hicks of the Museum of
HP Calculators and have been included in this package by his permission:
        http://www.hpmuseum.org/

Bernhard Engl, Richard Ottosen, and Jim Philips provided assistance with
circuit designs for PMOS interfacing.

Bernhard Engl reverse-engineered the bank-switching feature of the
Woodstock series ROM chips, and built a ROM emulator which was used
to run keycode verification tests.

HrastProgrammer provided assistance with getting the Voyager calculator
simulation working.

-----------------------------------------------------------------------------

Ports:

David G. Hicks translated the earlier csim HP-45 simulator to Java:
        http://www.hpmuseum.org/simulate/sim45.htm

Jonathan Purvis ported csim to PalmOS:
        http://one-two-three-four-five.com/palm/csim/

Maciej Bartosiak ported the earlier nsim HP-41CV simulator to MacOS X:
	http://homepage.mac.com/mba/nsim/

-----------------------------------------------------------------------------

Notices:

Nonpareil is not an HP product, and is not endorsed by HP.

Nonpareil is free software; you can redistribute it and/or modify it
under the terms of the GNU General Public License version 2 as
published by the Free Software Foundation.  Note that I am not
granting permission to redistribute or modify Nonpareil under the
terms of any later version of the General Public License.

Nonpareil is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program (in the file "COPYING"); if not, write to the
Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,
MA 02111, USA.
